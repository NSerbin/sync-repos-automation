name: Sync forks (weekly)

on:
  schedule:
    - cron: "15 3 * * 0" # Sunday 03:15 UTC
  workflow_dispatch:
    inputs:
      only_repo:
        description: "Optional: Sync only one repo (ORG/REPO). Empty = ALL."
        required: false
        default: ""

permissions:
  contents: write

jobs:
  build_matrices:
    runs-on: ubuntu-latest
    outputs:
      sync_matrix: ${{ steps.out.outputs.sync_matrix }}
      build_matrix: ${{ steps.out.outputs.build_matrix }}
      build_count: ${{ steps.out.outputs.build_count }}
    steps:
      - uses: actions/checkout@v4

      - id: out
        name: Build matrices from repos.yml
        shell: bash
        env:
          ONLY_REPO: ${{ github.event.inputs.only_repo }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, sys, json, yaml

          with open("repos.yml", "r") as f:
            cfg = yaml.safe_load(f) or {}

          defaults = cfg.get("defaults", {}) or {}
          repos = cfg.get("repos", []) or []
          if not repos:
            print("repos.yml has no repos", file=sys.stderr)
            sys.exit(1)

          only = (os.getenv("ONLY_REPO") or "").strip()

          sync_include = []
          build_include = []

          for r in repos:
            rr = dict(defaults)
            rr.update(r)

            rr.setdefault("upstream_branch", "main")
            rr.setdefault("target_branch", "main")
            rr.setdefault("fetch_tags", True)

            # normalize docker block
            docker = rr.get("docker") or {}
            rr["docker"] = docker
            rr["docker"]["enabled"] = bool(docker.get("enabled", False))

            # default projects = [name]
            projects = docker.get("projects")
            if not projects:
              projects = [rr.get("name")]
            rr["docker"]["projects"] = projects

            if only and rr.get("target_repo") != only:
              continue

            sync_include.append(rr)

            if rr["docker"]["enabled"]:
              build_include.append(rr)

          if only and not sync_include:
            print(f"ONLY_REPO '{only}' not found in repos.yml", file=sys.stderr)
            sys.exit(1)

          sync_matrix = json.dumps({"include": sync_include})
          build_matrix = json.dumps({"include": build_include})
          build_count = str(len(build_include))

          gh_out = os.environ["GITHUB_OUTPUT"]
          with open(gh_out, "a") as fh:
            fh.write(f"sync_matrix={sync_matrix}\n")
            fh.write(f"build_matrix={build_matrix}\n")
            fh.write(f"build_count={build_count}\n")

          print("SYNC:", sync_matrix)
          print("BUILD:", build_matrix)
          print("BUILD_COUNT:", build_count)
          PY

  sync:
    needs: build_matrices
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix: ${{ fromJson(needs.build_matrices.outputs.sync_matrix) }}

    uses: NSerbin/gh-pipelines/.github/workflows/upstream-sync.yml@main
    with:
      target_repo: ${{ matrix.target_repo }}
      upstream_url: ${{ matrix.upstream_url }}
      upstream_branch: ${{ matrix.upstream_branch }}
      target_branch: ${{ matrix.target_branch }}
      fetch_tags: ${{ matrix.fetch_tags }}

    secrets:
      SYNC_APP_ID: ${{ secrets.SYNC_APP_ID }}
      SYNC_APP_PRIVATE_KEY: ${{ secrets.SYNC_APP_PRIVATE_KEY }}

  dispatch_builder:
    name: Dispatch docker builds (docker.enabled=true)
    needs: [build_matrices, sync]
    runs-on: ubuntu-latest
    if: ${{ needs.build_matrices.outputs.build_count != '0' }}

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix: ${{ fromJson(needs.build_matrices.outputs.build_matrix) }}

    steps:
      - name: Mint GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SYNC_APP_ID }}
          private-key: ${{ secrets.SYNC_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Dispatch builds to docker-builder-projects
        shell: bash
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          BUILDER_REPO: "NSerbin/docker-builder-projects"
          SOURCE_REPO: ${{ matrix.target_repo }}
          REF: ${{ matrix.target_branch }}
          REPO_NAME: ${{ matrix.name }}
          PROJECTS_JSON: ${{ toJson(matrix.docker.projects) }}
        run: |
          set -euo pipefail

          echo "Dispatching build(s) for ${REPO_NAME} from ${SOURCE_REPO}@${REF}"
          echo "Projects json: ${PROJECTS_JSON}"

          # iter projects array
          projects="$(echo "${PROJECTS_JSON}" | jq -r '.[]')"

          if [ -z "${projects}" ]; then
            echo "No projects resolved. This should not happen."
            exit 1
          fi

          echo "${projects}" | sed 's/^/ - /'

          while read -r project; do
            [ -z "${project}" ] && continue
            echo "Dispatch project=${project}"

            gh api \
              -X POST \
              "repos/${BUILDER_REPO}/dispatches" \
              -f event_type="builder.build" \
              -f client_payload[repo_name]="${project}" \
              -f client_payload[source_repo]="${SOURCE_REPO}" \
              -f client_payload[ref]="${REF}"
          done <<< "${projects}"
